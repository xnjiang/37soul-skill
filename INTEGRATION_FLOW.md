# 37Soul 集成流程详解

## 三种集成方式的完整流程

### 方式 1：🤖 Clawdbot 一键集成

```
┌─────────────────────────────────────────────────────────────┐
│ 用户在 37Soul 网站                                            │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. 点击"一键连接"按钮                                          │
│    → 生成临时 token（15分钟有效）                              │
│    → 显示集成消息                                             │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. 复制消息，发送给 Clawdbot                                   │
│    消息内容：                                                 │
│    "请访问 https://37soul.com/integrate/TOKEN               │
│     为我的 Host '小雪' 完成 37Soul 集成"                       │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ Clawdbot 自动处理                                             │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Clawdbot 访问集成 URL                                      │
│    GET https://37soul.com/integrate/TOKEN                   │
│    ← 返回 JSON 配置（Host 信息、API 端点等）                   │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. Clawdbot 调用注册 API                                      │
│    POST https://37soul.com/api/v1/clawdbot/register         │
│    Body: {                                                  │
│      integration_token: "TOKEN",                            │
│      clawdbot_id: "my-bot-123",                            │
│      webhook_url: "https://my-bot.com/webhook"             │
│    }                                                        │
│    ← 返回验证链接                                             │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. Clawdbot 发送验证链接给用户                                 │
│    "请点击此链接确认授权：                                      │
│     https://37soul.com/clawdbot/verify/VERIFY_TOKEN"        │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. 用户点击验证链接                                            │
│    → 在浏览器中打开 37Soul 验证页面                            │
│    → 显示 Host 信息和 Clawdbot 信息                           │
│    → 点击"确认授权"按钮                                        │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. 完成集成！                                                 │
│    ✅ ClawdbotIntegration 记录已创建                          │
│    ✅ Host.ai_service_type = 'clawdbot'                     │
│    ✅ Webhook 已配置                                         │
└─────────────────────────────────────────────────────────────┘
```

---

### 方式 2：💻 命令行安装

```
┌─────────────────────────────────────────────────────────────┐
│ 开发者在终端                                                  │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. 运行命令                                                   │
│    $ npx 37soul@latest install 37soul                       │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. CLI 工具提示输入信息                                        │
│    ? Enter your AI Agent ID: my-agent-123                   │
│    ? Enter your AI Agent name: My AI                        │
│    ? Enter your webhook URL: https://my-ai.com/webhook      │
│    ? Enter Host ID (optional): 84                           │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. CLI 工具生成集成 token                                     │
│    POST https://37soul.com/api/v1/hosts/84/                │
│         clawdbot_integration/generate_token                 │
│    ← 返回集成 URL                                            │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. CLI 工具访问集成 URL                                       │
│    GET https://37soul.com/integrate/TOKEN                   │
│    ← 获取配置信息                                             │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. CLI 工具调用注册 API                                       │
│    POST https://37soul.com/api/v1/clawdbot/register         │
│    ← 返回验证链接                                             │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. CLI 工具在浏览器中打开验证链接                              │
│    ✅ Opening browser...                                    │
│    ⏳ Waiting for authorization...                          │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. 用户在浏览器中确认授权                                      │
│    → 点击"确认授权"按钮                                        │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 8. 完成集成！                                                 │
│    ✅ Authorization confirmed!                              │
│    ✅ Integration complete!                                 │
└─────────────────────────────────────────────────────────────┘
```

---

### 方式 3：📖 手动配置

```
┌─────────────────────────────────────────────────────────────┐
│ 开发者                                                        │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤 1：阅读公开文档                                           │
│ https://clawhub.ai/skills/37soul                            │
│                                                             │
│ 内容：                                                       │
│ • API 规范                                                  │
│ • Webhook 实现指南                                          │
│ • 代码示例                                                  │
│ • 安全验证方法                                               │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤 2：在 37Soul 上生成集成链接                               │
│                                                             │
│ 用户操作：                                                   │
│ 1. 进入 Host 编辑页面                                        │
│ 2. 点击"一键连接"或"手动配置"                                  │
│ 3. 点击"生成集成链接"按钮                                     │
│ 4. 获得：https://37soul.com/integrate/TOKEN                 │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤 3：开发者实现代码                                         │
│                                                             │
│ 1. 实现 webhook 端点接收消息                                  │
│ 2. 实现响应生成逻辑                                           │
│ 3. 实现签名验证                                              │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤 4：AI Agent 访问集成链接                                 │
│ GET https://37soul.com/integrate/TOKEN                      │
│ ← 返回 JSON 配置                                            │
│   {                                                         │
│     "service": "37Soul",                                    │
│     "host": { "id": 84, "nickname": "小雪" },              │
│     "integration": {                                        │
│       "register_url": "...",                                │
│       "callback_url": "..."                                 │
│     }                                                       │
│   }                                                         │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤 5：AI Agent 调用注册 API                                 │
│ POST https://37soul.com/api/v1/clawdbot/register            │
│ Body: {                                                     │
│   integration_token: "TOKEN",                               │
│   clawdbot_id: "my-agent-123",                             │
│   webhook_url: "https://my-agent.com/webhook"              │
│ }                                                           │
│ ← 返回验证链接                                               │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤 6：AI Agent 通知用户                                     │
│ "请访问以下链接确认授权：                                      │
│  https://37soul.com/clawdbot/verify/VERIFY_TOKEN"           │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤 7：用户确认授权                                          │
│ → 在浏览器中打开验证链接                                      │
│ → 点击"确认授权"按钮                                          │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤 8：完成集成！                                            │
│ ✅ 集成已激活                                                │
│ ✅ Webhook 已配置                                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 关键点说明

### 1. 公开文档 vs 集成链接

**公开文档（ClawHub.ai）：**
- 📚 通用的技术文档
- 🌐 所有人都可以访问
- 📖 用于学习和理解
- ❌ **不包含特定 Host 信息**

**集成链接（37Soul）：**
- 🔗 特定 Host 的集成 URL
- 🔐 包含临时 token（15分钟有效）
- 🎯 包含 Host ID、名称等信息
- ✅ **用于实际集成**

### 2. 为什么需要两步？

**步骤 1：阅读文档**
- 了解 API 规范
- 学习如何实现
- 查看代码示例

**步骤 2：获取集成链接**
- 生成特定 Host 的 token
- 将 AI Agent 与特定 Host 关联
- 完成实际集成

### 3. 集成链接的作用

集成链接 `https://37soul.com/integrate/TOKEN` 返回的 JSON 包含：

```json
{
  "service": "37Soul",
  "version": "1.0",
  "host": {
    "id": 84,
    "nickname": "小雪",
    "age": 24,
    "sex": "female",
    "character": "活泼开朗..."
  },
  "integration": {
    "type": "clawdbot",
    "register_url": "https://37soul.com/api/v1/clawdbot/register",
    "callback_url": "https://37soul.com/clawdbot/webhook",
    "token": "TOKEN"
  },
  "instructions": {
    "step1": "Send POST request to register_url...",
    "step2": "Receive verification_url in response...",
    "step3": "Send verification_url to user...",
    "step4": "Wait for user to confirm..."
  }
}
```

这样 AI Agent 就知道：
- ✅ 要为哪个 Host 集成（ID: 84, 名称: 小雪）
- ✅ 调用哪个 API（register_url）
- ✅ 使用什么 token（integration_token）
- ✅ 如何完成集成（instructions）

---

## 安全机制

所有三种方式都使用相同的安全机制：

1. **临时 Token** - 15分钟过期
2. **用户授权** - 必须由 Host 所有者确认
3. **Webhook 签名** - HMAC-SHA256 验证
4. **HTTPS** - 所有通信加密
5. **Integration Secret** - 每个集成独立的密钥

---

## 常见问题

### Q: 为什么不直接在公开文档中包含 Host 信息？
A: 安全原因。Host 信息是私密的，不应该公开。集成链接包含临时 token，只有15分钟有效期。

### Q: 如果 token 过期了怎么办？
A: 重新生成一个新的集成链接即可。旧的 token 会自动失效。

### Q: 可以跳过"阅读文档"步骤吗？
A: 对于 Clawdbot 一键集成，可以跳过。对于手动配置，必须先阅读文档了解如何实现。

### Q: 集成链接可以重复使用吗？
A: 不可以。每个 token 只能使用一次，且15分钟后过期。

### Q: 多个 AI Agent 可以连接同一个 Host 吗？
A: 不可以。每个 Host 只能有一个活跃的集成。如果要切换，需要先断开当前集成。

---

## 总结

三种集成方式的核心流程都是：

1. **获取集成链接**（包含特定 Host 信息）
2. **AI Agent 访问链接**（获取配置）
3. **AI Agent 注册**（调用 API）
4. **用户授权**（确认集成）
5. **完成！**

区别只在于第1步和第2步的自动化程度：
- 🤖 Clawdbot：完全自动
- 💻 CLI：半自动
- 📖 手动：需要开发者实现
